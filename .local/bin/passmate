#!/bin/env bash

list_passwords() {
	# prefix=${PASSWORD_STORE_DIR-~/.password-store}
	prefix=~/.local/share/pass
	password_files=("$prefix"/**/*.gpg)
	password_files=("${password_files[@]#"$prefix"/}")
	password_files=("${password_files[@]%.gpg}")
	passwords_list=$(printf '%s\n' "${password_files[@]}" | sed 's/\.gpg$//')
	echo "$passwords_list"
}

show_passwords() {
	local passwords_list=$(list_passwords)
	local selected_entry=$(echo "$passwords_list" | rofi -dmenu -p "Select password:")
	echo "$selected_entry"
}

get_password() {
	local password_entry=$1
	local password=$(pass show "$password_entry" | head -n1)
	echo "$password"
}

copy_to_clipboard_wayland() {
	local password=$1
	echo -n "$password" | wl-copy -n
	notify-send "Password copied to clipboard!"
}

delete_from_cliphist_clipboard() {
	sleep 45 && cliphist delete-query "$password" | wl-copy -c
	notify-send "Clipboard cleared!"
}

# Function to print script usage
print_usage() {
	echo "Usage: $(basename "$0") [-h] [-c]"
	echo "Options:"
	echo "  -h   Show this help message."
	echo "  -c   Specify clipboard tool to use. Options: 'wayland' or 'xclip'. (Default: wayland)"
	echo "  -d   Delete from clipboard after 45 seconds (Default: false). Works for wayland with cliphist only."
}

# Main function to execute the script
main() {
	local clipboard_tool="wayland" # Set default clipboard tool to wayland
	local delete_passwords=false

	while getopts ":hc:d" opt; do
		case "$opt" in
		h)
			print_usage
			exit 0
			;;
		c) clipboard_tool="$OPTARG" ;;
		d) delete_passwords=true ;;
		\?)
			echo "Invalid option: -$OPTARG"
			print_usage
			exit 1
			;;
		esac
	done

	if [ "$clipboard_tool" = "" ]; then
		echo "Please specify a clipboard tool with -c option (wayland or xclip)."
		print_usage
		exit 1
	fi

	local selected_entry=$(show_passwords)

	if [ "$selected_entry" != "" ]; then
		echo "Selected password: $selected_entry"
		password=$(get_password "$selected_entry")
		if [ "$clipboard_tool" = "wayland" ]; then
			copy_to_clipboard_wayland "$password"
			echo "Password copied to clipboard using Wayland!"
			if [ "$delete_passwords" = true ]; then
				delete_from_cliphist_clipboard "$password"
			fi
		elif [ "$clipboard_tool" = "xclip" ]; then
			copy_to_clipboard_xclip "$password"
			echo "Password copied to clipboard using xclip!"
		else
			echo "Invalid clipboard tool. Options: 'wayland' or 'xclip'."
			exit 1
		fi
	else
		echo "No password selected. Exiting..."
		exit 1
	fi
}

main "$@"
