#!/usr/bin/env python3
import re
import subprocess


PROMPT_RE = re.compile(r"^\[[A-Z]\] .*?> ")


def main() -> int:
    capture = subprocess.check_output(
        ["tmux", "capture-pane", "-p", "-S", "-", "-J"], text=True
    )
    lines = capture.splitlines()
    prompt_lines = [i for i, line in enumerate(lines) if PROMPT_RE.match(line)]

    if not prompt_lines:
        return 1

    if len(prompt_lines) >= 2:
        start_index = prompt_lines[-2]
        end_index = prompt_lines[-1]
    else:
        start_index = prompt_lines[-1]
        end_index = len(lines)

    selection_lines = lines[start_index:end_index]

    while selection_lines and selection_lines[0].strip() == "":
        selection_lines.pop(0)
    while selection_lines and selection_lines[-1].strip() == "":
        selection_lines.pop()

    selection = "\n".join(selection_lines)

    subprocess.run(["wl-copy"], input=selection, text=True, check=False)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
